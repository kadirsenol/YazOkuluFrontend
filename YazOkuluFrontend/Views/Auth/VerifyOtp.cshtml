@model string

<div class="max-w-md mx-auto bg-white p-8 shadow rounded-lg mt-40">
    <h2 class="text-2xl font-semibold mb-6 text-center">OTP Doğrulama</h2>

    <p class="text-center text-gray-600 mb-4">
        Telefonunuza gönderdiğimiz <strong>6 haneli kodu</strong> giriniz.
    </p>

    <form id="verifyOtpForm" class="space-y-4">
        <div>
            <label class="block text-gray-700 mb-1">Gelen Kod</label>
            <input type="text" name="otp" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required />
        </div>
        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">Giriş Yap</button>
    </form>
</div>

@section Scripts {
    <script>
        document.getElementById("verifyOtpForm").addEventListener("submit", async function (e) {
            e.preventDefault();

          
            const otp = document.querySelector("input[name='otp']").value.trim();

           
            const gsm = localStorage.getItem("GSM");

            if (!gsm) {
                showToast("GSM bulunamadı! Lütfen OTP isteği oluşturun.", "error");
                return;
            }

            if (!otp) {
                showToast("Lütfen OTP kodunu giriniz.", "error");
                return;
            }

            const requestBody = {
                gsm: gsm,
                otp: otp
            };

            try {
                const response = await fetch("http://localhost:5273/api/auth/verify-otp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (response.ok && result.isSuccess !== false) {

                   
                    const token = result?.resultObject?.detail?.token;

                    if (token) {
                        
                        localStorage.setItem("Token", token);
                        document.cookie = `Token=${token}; path=/;`;//role kontrolu icin
                    }

                    showToast("OTP doğrulandı! Giriş başarılı.", "success");

                    
                    localStorage.removeItem("GSM");

                    
                    setTimeout(() => window.location.href = "/Home/Index", 1500);

                } else {
                    showToast(result.message || "OTP doğrulanamadı.", "error");
                }

            } catch (error) {
                console.error(error);
                showToast("Sunucuyla iletişim kurulamadı.", "error");
            }
        });
    </script>
}

